<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Arrays" href="arrays.html" /><link rel="prev" title="GRT" href="grt.html" />

    <link rel="shortcut icon" href="../../_static/icon.ico"/><!-- Generated with Sphinx 7.2.6 and Furo 2024.08.06 -->
        <title>Shared libs and dynamic loading - GHDL-cosim latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">GHDL-cosim latest documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">GHDL-cosim latest documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../ci.html">Continuous Integration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">VHPIDIRECT</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../declarations.html">Type declarations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wrapping.html">Wrapping a simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linking.html">Linking object files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dynamic.html">Dynamic loading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../grt.html">Using GRT</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Examples</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="grt.html">GRT</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Shared libs and dynamic loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="arrays.html">Arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="vffi_user.html">FFI/DPI Header</a></li>
<li class="toctree-l2"><a class="reference internal" href="other.html">Other co-simulation projects</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notebook/index.html">Notebook</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Notebook</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notebook/howtouseghdlfromc.html">How to use GHDL from an external C program?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebook/memorylayout.html">Memory Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebook/mistakes.html">Common mistakes</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">VPI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../vpi/index.html">Introduction</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../vpi/examples/index.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../vpi/examples/quickstart.html">Quick Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vpi/examples/other.html">Other co-simulation projects</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">VPHI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../vhpi/index.html">Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../License.html">Apache License 2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Doc-License.html">Creative Commons Attribution 4.0 International</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../../_sources/vhpidirect/examples/shared.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="shared-libs-and-dynamic-loading">
<span id="cosim-vhpidirect-examples-shared"></span><h1>Shared libs and dynamic loading<a class="headerlink" href="#shared-libs-and-dynamic-loading" title="Link to this heading">¶</a></h1>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>As explained in <a class="reference internal" href="../dynamic.html#cosim-vhpidirect-dynamic-loading-a-simulation"><span class="std std-ref">Loading a simulation</span></a>, in order to load binaries/libraries dynamically,
those need to be built as position independent code/executables (PIC/PIE).</p>
</div>
<p>This set of examples is an introduction from scratch for users who are familiar with C, but who have never built or loaded
shared libraries (<code class="docutils literal notranslate"><span class="pre">*.so</span></code>, <code class="docutils literal notranslate"><span class="pre">*.dll</span></code> or <code class="docutils literal notranslate"><span class="pre">*.dyn</span></code>):</p>
<ul class="simple">
<li><p><a class="reference internal" href="#cosim-vhpidirect-examples-shared-shlib"><span class="std std-ref">shlib</span></a>: write C code and compile it as a shared library.</p></li>
<li><p><a class="reference internal" href="#cosim-vhpidirect-examples-shared-dlopen"><span class="std std-ref">dlopen</span></a>: write two shared libraries in C, and write a main C program for loading and executing both of them.</p></li>
<li><p><a class="reference internal" href="#cosim-vhpidirect-examples-shared-shghdl"><span class="std std-ref">shghdl</span></a>: build a simulation as a shared library, and write a main C program for loading and executing it.</p></li>
<li><p><a class="reference internal" href="#cosim-vhpidirect-examples-shared-py"><span class="std std-ref">py</span></a>: build a simulation as a shared library, and write a Python script for loading and executing it.</p></li>
<li><p><a class="reference internal" href="#cosim-vhpidirect-examples-shared-pycb"><span class="std std-ref">pycb</span></a>: build a simulation as a shared library, and write a Python script for loading it and replacing callbacks
through <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> before executing the simulation.</p></li>
</ul>
<section id="shlib">
<span id="cosim-vhpidirect-examples-shared-shlib"></span><h2><a class="reference external" href="https://github.com/ghdl/ghdl-cosim/blob/master/vhpidirect/shared/shlib">shlib</a><a class="headerlink" href="#shlib" title="Link to this heading">¶</a></h2>
<p>This example features the same functionality as <a class="reference internal" href="quickstart.html#cosim-vhpidirect-examples-quickstart-random"><span class="std std-ref">‘rand’ from stdlib</span></a>. However, custom C
sources are used (as in <a class="reference internal" href="quickstart.html#cosim-vhpidirect-examples-quickstart-customc"><span class="std std-ref">custom C</span></a>) and these are built as a shared library.
See <a class="reference internal" href="../dynamic.html#cosim-vhpidirect-dynamic-loading-within-a-simulation"><span class="std std-ref">Loading foreign objects from within a simulation</span></a> for further info.</p>
</section>
<section id="dlopen">
<span id="cosim-vhpidirect-examples-shared-dlopen"></span><h2><a class="reference external" href="https://github.com/ghdl/ghdl-cosim/blob/master/vhpidirect/shared/dlopen">dlopen</a><a class="headerlink" href="#dlopen" title="Link to this heading">¶</a></h2>
<p>Although this example does not include a simulation built with GHDL, it is a test and the introduction to the next
example. In this test, two separate shared libraries are built from C sources, both including a function named
<code class="docutils literal notranslate"><span class="pre">ghdl_main</span></code>. Then, in a main C application, both shared libraries are dynamically loaded at the same time, and both
are executed (one after the other).</p>
<p>This example tests whether symbol <code class="docutils literal notranslate"><span class="pre">ghdl_main</span></code> is visible in the shared libraries, and whether the same symbol name
can be loaded from multiple shared libraries (and used) at the same time.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If the symbol is not found, try adding <cite>-g</cite>, <cite>-rdynamic</cite> and/or <cite>-O0</cite> when building the shared libraries. Tools such
as <code class="docutils literal notranslate"><span class="pre">objdump</span></code>, <code class="docutils literal notranslate"><span class="pre">readelf</span></code> or <code class="docutils literal notranslate"><span class="pre">nm</span></code> can be used to check if a symbol is visible. For instance, <code class="docutils literal notranslate"><span class="pre">objdump</span> <span class="pre">-d</span> <span class="pre">corea.so</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">ghdl_main</span></code>.</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Building multiple designs as separate artifacts and dynamically loading them at the same time is a naive approach to
multi-core simulation with GHDL. It is also a possible solution for coarse grained co-simulation with Verilator.</p>
</div>
</section>
<section id="shghdl">
<span id="cosim-vhpidirect-examples-shared-shghdl"></span><h2><a class="reference external" href="https://github.com/ghdl/ghdl-cosim/blob/master/vhpidirect/shared/shghdl">shghdl</a><a class="headerlink" href="#shghdl" title="Link to this heading">¶</a></h2>
<p>This example is complementary to <a class="reference internal" href="#cosim-vhpidirect-examples-shared-shlib"><span class="std std-ref">shlib</span></a>, since the VHDL simulation is built as a
shared library, which is then loaded from a main C application (as in <a class="reference internal" href="#cosim-vhpidirect-examples-shared-dlopen"><span class="std std-ref">dlopen</span></a>).</p>
<p>When <code class="docutils literal notranslate"><span class="pre">main</span></code> is executed:</p>
<ul class="simple">
<li><p>The shared libray is loaded, symbol <code class="docutils literal notranslate"><span class="pre">print_something</span></code> is searched for, and it is executed.</p></li>
<li><p>Symbol <code class="docutils literal notranslate"><span class="pre">ghdl_main</span></code> is searched for, and it is executed three times. Unfortunately, GHDL does not currently support
reseting/restarting the simulation runtime. Hence, in this example the shared library is unloaded and loaded again
before calling <code class="docutils literal notranslate"><span class="pre">ghdl_main</span></code> after the first time.</p></li>
</ul>
<p>See <a class="reference internal" href="../dynamic.html#cosim-vhpidirect-dynamic-generating-shared-libraries"><span class="std std-ref">Generating shared libraries</span></a> for further details with regard to the visibility of
symbols in the shared libraries.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On GNU/linux, both executable binaries and shared libraries use the ELF format. As a result, although hackish, it is
possible to load an executable binary dynamically, i.e. without using any of the <code class="docutils literal notranslate"><span class="pre">shared</span></code> options explained in
<a class="reference internal" href="../dynamic.html#cosim-vhpidirect-dynamic-generating-shared-libraries"><span class="std std-ref">Generating shared libraries</span></a>. In this example, this case is also tested. However, this
is not suggested at all, since it won’t work on all platforms.</p>
</div>
</section>
<section id="py">
<span id="cosim-vhpidirect-examples-shared-py"></span><h2><a class="reference external" href="https://github.com/ghdl/ghdl-cosim/blob/master/vhpidirect/shared/py">py</a><a class="headerlink" href="#py" title="Link to this heading">¶</a></h2>
<p><a class="reference external" href="https://www.python.org/">Python</a>’s <a class="reference external" href="https://docs.python.org/3.8/library/ctypes.html#module-ctypes" title="(in Python v3.8)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">ctypes</span></code></a> module is a built-in “<em>foreign function library for Python</em>”, which
“<em>provides C compatible data types, and allows calling functions in DLLs or shared libraries</em>”. Thus, it is posible to
reproduce <a class="reference internal" href="#cosim-vhpidirect-examples-shared-shghdl"><span class="std std-ref">shghdl</span></a> by loading and executing the simulation from Python, instead of
C.</p>
<p>This example uses the testbench and C sources from <a class="reference internal" href="quickstart.html#cosim-vhpidirect-examples-quickstart-wrapping-exitcb"><span class="std std-ref">exitcb</span></a>, but the simulation
is built as a shared library and loaded dynamically from Python. A helper Python module is used for providing OS agnostic
utilities (see <a class="reference external" href="https://github.com/ghdl/ghdl-cosim/blob/master/vhpidirect/shared/py/pyaux.py">pyaux.py</a>).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>On some Linux environments, failing simulations that are dynamically loaded from Python do produce an <em>Abortion</em>. This
forces the wrapper/caller to exit inmediately, without running any post-check. See <a class="reference external" href="https://github.com/ghdl/ghdl/issues/803">ghdl#803</a> and <a class="reference external" href="https://github.com/ghdl/ghdl-cosim/issues/15">ghdl-cosim#15</a> for
further details.</p>
</div>
<section id="py-vunit">
<h3><a class="reference external" href="https://github.com/ghdl/ghdl-cosim/blob/master/vhpidirect/shared/py/vunit">py/vunit</a><a class="headerlink" href="#py-vunit" title="Link to this heading">¶</a></h3>
<p>This is equivalent to the previous example (<a class="reference internal" href="#cosim-vhpidirect-examples-shared-py"><span class="std std-ref">py</span></a>). Instead of calling GHDL’s CLI explicitly,
VUnit’s Python aided plumbing is used. This allows including any of VUnit’s VHDL features into the simulation models, which
are then to be loaded dynamically from Python. In fact, this is the foundation of <a class="reference external" href="https://github.com/VUnit/cosim">VUnit/cosim</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>On some Linux environments, using VHDL 2008 works but VHDL 1993 does not return cleanly in case of failure. An <em>Abortion</em> is
produced, which prevents the regular after-simulation execution of VUnit. See <a class="reference external" href="https://github.com/ghdl/ghdl/issues/803">ghdl#803</a> and <a class="reference external" href="https://github.com/ghdl/ghdl-cosim/issues/15">ghdl-cosim#15</a> for
further details.</p>
</div>
</section>
</section>
<section id="pycb">
<span id="cosim-vhpidirect-examples-shared-pycb"></span><h2><a class="reference external" href="https://github.com/ghdl/ghdl-cosim/blob/master/vhpidirect/shared/pycb">pycb</a><a class="headerlink" href="#pycb" title="Link to this heading">¶</a></h2>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>This example is conceptually built on top of <a class="reference internal" href="#cosim-vhpidirect-examples-shared-shghdl"><span class="std std-ref">shghdl</span></a> and <a class="reference internal" href="#cosim-vhpidirect-examples-shared-py"><span class="std std-ref">py</span></a>;
so it is strongly suggested to carefully read those first. Since Pyhon and <a class="reference external" href="https://docs.python.org/3.8/library/ctypes.html#module-ctypes" title="(in Python v3.8)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">ctypes</span></code></a> are used, a good understanding of
the underlaying C syntax and semantics is required.</p>
</div>
<p>The main purpose of this example is to showcase how to execute an arbitrary Python function from a VHDL testbench, by calling
it as a regular VHDL procedure/function and passing (complex) parameters from the VHDL domain. Precisely, function <code class="docutils literal notranslate"><span class="pre">plot(x,y)</span></code>
from <a class="reference external" href="https://matplotlib.org/stable/api/pyplot_summary.html#module-matplotlib.pyplot" title="(in Matplotlib v3.9.2)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code></a> is used to draw <code class="docutils literal notranslate"><span class="pre">x,y</span></code> graphs from constrained arrays of integers in VHDL. The scheme is as
follows:</p>
<ul class="simple">
<li><p>A <strong>function prototype is defined in C</strong>. This is the definition that will be <em>common</em> to C, VHDL and Python. The prototype
in this example is <code class="docutils literal notranslate"><span class="pre">(int*</span> <span class="pre">x,</span> <span class="pre">int*</span> <span class="pre">y,</span> <span class="pre">int</span> <span class="pre">l)</span></code>, i.e. two pointers to arrays of integers are passed, and a third argument
tells the length.</p></li>
<li><p>(optional) A default implementation of the function is written in C. This is just a placeholder/canary.</p></li>
<li><p>A <strong>function pointer variable is created</strong>, and it is initialized to the address of the default implementation.</p></li>
<li><p>The <strong>function pointer variable is used</strong> (dereferenced and executed) <strong>either from C, or from VHDL through VHPIDIRECT</strong>.</p></li>
<li><p><strong>C/VHDL sources are built as a shared library</strong>.</p></li>
<li><p><strong>From Python</strong>, an alternative implementation of the function is written. <strong>After loading the library, but before executing
the simulation, the function pointer variable is set</strong> to the address of the alternative implementation.</p></li>
</ul>
<p>As a result, at runtime, when VHDL calls the external function, the Python callback is executed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For didactic purposes, the run script in this example first uses C and Python only. I.e., arrays are initialized in C and
plotted in Python. Then, in subdir <a class="reference external" href="https://github.com/ghdl/ghdl-cosim/blob/master/vhpidirect/shared/pycb/pyghdl">pycb</a>, arrays are initialized in a VHDL
testbench instead.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In <a class="reference external" href="https://github.com/dbhi/vboard/tree/main/vga">dbhi/vboard: VGA test pattern</a>, this example and <a class="reference internal" href="arrays.html#cosim-vhpidirect-examples-arrays-matrices-vga"><span class="std std-ref">VGA (RGB image buffer)</span></a>
are combined for providing a <em>virtual VGA screen</em> using Python’s <a class="reference external" href="https://numpy.org/">NumPy</a>, <a class="reference external" href="https://python-pillow.org/">Pillow</a>
and <a class="reference external" href="https://docs.python.org/3/library/tkinter.html">Tkinter</a>.
Equivalent solutions can be implemented using Python libraries such as <a class="reference external" href="https://matplotlib.org/">matplotlib</a>,
<a class="reference external" href="https://www.panda3d.org/">panda3d</a>, <a class="reference external" href="https://www.pygame.org">pygame</a>, <a class="reference external" href="http://cocos2d.org/#cocos2dpy">cocos2dpy</a>, <a class="reference external" href="http://pyglet.org/">pyglet</a>, etc.
Do you want to take up the challenge? <a class="reference external" href="https://github.com/ghdl/ghdl-cosim/compare">Propose a PR</a>!</p>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="arrays.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Arrays</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="grt.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">GRT</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2020-2023, Tristan Gingold and contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Shared libs and dynamic loading</a><ul>
<li><a class="reference internal" href="#shlib">shlib</a></li>
<li><a class="reference internal" href="#dlopen">dlopen</a></li>
<li><a class="reference internal" href="#shghdl">shghdl</a></li>
<li><a class="reference internal" href="#py">py</a><ul>
<li><a class="reference internal" href="#py-vunit">py/vunit</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pycb">pycb</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=c6e86fd7"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>